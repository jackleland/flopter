

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>splopter &mdash; flopter  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> flopter
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">flopter</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>splopter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for splopter</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">loadmat</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">argrelmax</span><span class="p">,</span> <span class="n">savgol_filter</span>

<span class="kn">from</span> <span class="nn">classes.base</span> <span class="k">import</span> <span class="n">IVAnalyser</span>
<span class="kn">from</span> <span class="nn">classes.fitdata</span> <span class="k">import</span> <span class="n">IVFitData</span>
<span class="kn">from</span> <span class="nn">classes.ivdata</span> <span class="k">import</span> <span class="n">IVData</span>
<span class="kn">import</span> <span class="nn">classes.spicedata</span> <span class="k">as</span> <span class="nn">sd</span>
<span class="kn">import</span> <span class="nn">constants</span> <span class="k">as</span> <span class="nn">c</span>
<span class="kn">from</span> <span class="nn">homogenisation</span> <span class="k">import</span> <span class="n">Spice2Homogeniser</span>
<span class="kn">from</span> <span class="nn">inputparser</span> <span class="k">import</span> <span class="n">InputParser</span>
<span class="kn">from</span> <span class="nn">normalisation</span> <span class="k">import</span> <span class="n">Denormaliser</span>
<span class="kn">from</span> <span class="nn">fitters</span> <span class="k">import</span> <span class="n">IVFitter</span><span class="p">,</span> <span class="n">FullIVFitter</span><span class="p">,</span> <span class="n">GaussianFitter</span>
    

<div class="viewcode-block" id="Splopter"><a class="viewcode-back" href="../index.html#splopter.Splopter">[docs]</a><span class="k">class</span> <span class="nc">Splopter</span><span class="p">(</span><span class="n">IVAnalyser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implementation of IVAnalyser for the analysis of probe data from SPICE</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_tfile_prefix</span> <span class="o">=</span> <span class="s1">&#39;t-&#39;</span>
    <span class="n">_file_suffix</span> <span class="o">=</span> <span class="s1">&#39;.mat&#39;</span>
    <span class="n">_dump_suffix</span> <span class="o">=</span> <span class="s1">&#39;.2d.&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_mount_dir</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prepare</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">##################################</span>
        <span class="c1">#             Extract            #</span>
        <span class="c1">##################################</span>

        <span class="c1"># Constants(ish)</span>
        <span class="n">spice_dir</span> <span class="o">=</span> <span class="s1">&#39;/home/jleland/Spice/spice2/&#39;</span>
        <span class="n">input_dir</span> <span class="o">=</span> <span class="n">spice_dir</span> <span class="o">+</span> <span class="s1">&#39;bin/inputs/&#39;</span>
        <span class="n">script_dir</span> <span class="o">=</span> <span class="n">spice_dir</span> <span class="o">+</span> <span class="s1">&#39;bin/scripts/&#39;</span>

        <span class="c1"># # Run specific data</span>
        <span class="c1"># data_mount_dir = &#39;bin/data/&#39;</span>
        <span class="c1"># group_name = &#39;benchmarking_sam/&#39;</span>
        <span class="c1"># folder_name = &#39;gapless_fullgrid/&#39;</span>
        <span class="c1"># data_dir = spice_dir + data_mount_dir + group_name + folder_name</span>

        <span class="c1"># ------------------- Run specific data ------------------- #</span>

        <span class="c1"># Cumulus</span>
        <span class="c1"># data_mount_dir = &#39;bin/data/&#39;</span>
        <span class="c1"># group_name = &#39;tests/&#39;</span>
        <span class="c1"># folder_name = &#39;fullgridtest/&#39;         # gapped fullgrid</span>
        <span class="c1"># folder_name = &#39;reversed_charge/&#39;</span>
        <span class="c1"># folder_name = &#39;prebiased_probe/&#39;</span>

        <span class="c1"># group_name = &#39;benchmarking_sam/&#39;</span>
        <span class="c1"># folder_name = &#39;gapless_fullgrid/&#39;</span>
        <span class="c1"># folder_name = &#39;gapless_halfgrid1/&#39;</span>
        <span class="c1"># folder_name = &#39;gapless_halfgrid2/&#39;</span>
        <span class="c1"># folder_name = &#39;nogaphalfgrid_tlong1/&#39;</span>
        <span class="c1"># folder_name = &#39;prebprobe_fullgap/&#39;</span>
        <span class="c1"># folder_name = &#39;prebprobe_fullnogap/&#39;</span>

        <span class="c1"># Freia</span>
        <span class="c1"># data_mount_dir = &#39;bin/data_f/&#39;</span>
        <span class="c1"># group_name = &#39;rundata&#39;</span>
        <span class="c1"># folder/name &#39;6-s-halfgrid&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">spice_dir</span> <span class="o">+</span> <span class="n">data_mount_dir</span> <span class="o">+</span> <span class="n">group_name</span> <span class="o">+</span> <span class="n">folder_name</span>

        <span class="c1"># input_filename = input_dir + &#39;jleland.3.inp&#39;</span>
        <span class="c1"># input_filename = input_dir + &#39;jleland.2.inp&#39;</span>
        <span class="c1"># input_filename = data_dir + &#39;s_benchmarking_nogap.inp&#39;</span>
        <span class="c1"># input_filename = data_dir + &#39;reversede_ng_hg_sbm.inp&#39;</span>
        <span class="c1"># input_filename = data_dir + &#39;prebiasprobe_ng_hg_sbm.inp&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s1">&#39;input.inp&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">run_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tfile_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">afile_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ta_filenames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_name_short</span> <span class="o">=</span> <span class="n">run_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">trun_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{a}{b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tfile_prefix</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">run_name_short</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tfile_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">+</span> <span class="n">trun_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_suffix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">afile_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">+</span> <span class="n">run_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_suffix</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfile_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tfile_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfile_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">Spice2TData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tfile_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No t-file given&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">afile_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">afile_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">afile_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">afile</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afile_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No a-file given, continuing without&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">afile</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">homogeniser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">prepare</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

<div class="viewcode-block" id="Splopter.prepare"><a class="viewcode-back" href="../index.html#splopter.Splopter.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">homogenise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make_denormaliser</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check existence of, and then populate, the main flopter objects: inputparser, denormaliser and homogeniser.</span>

<span class="sd">            Default behaviour is to populate all, mandatory behaviour is only to create input parser. Homogeniser and</span>
<span class="sd">            Denormaliser creation is controlled through the boolean input flags. Note that specifying the</span>
<span class="sd">            make_denormaliser flag does not automatically denormalise all data, it merely populates the denormaliser</span>
<span class="sd">            object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">InputParser</span><span class="p">(</span><span class="n">input_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">make_denormaliser</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span> <span class="o">=</span> <span class="n">Denormaliser</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">input_parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_se_temp_ratio</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span><span class="o">.</span><span class="n">set_se_temperature</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span>
        <span class="k">elif</span> <span class="n">make_denormaliser</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot make_denormaliser, data has already been denormalised!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">homogenise</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">homogeniser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">homogeniser</span> <span class="o">=</span> <span class="n">Spice2Homogeniser</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="p">,</span> <span class="n">input_parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">homogeniser</span><span class="o">.</span><span class="n">homogenise</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">homogenise</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">homogeniser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot homogenise, data has already been homogenised!&#39;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_ta_filenames</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="c1"># TODO: Update this to work with Paths</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Directory </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1"> invlaid.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
        <span class="n">tfile_all_glob_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">*</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_tfile_prefix</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_file_suffix</span><span class="p">)</span>
        <span class="n">tfile_num_glob_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">*[0-9][0-9]</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_tfile_prefix</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_file_suffix</span><span class="p">)</span>
        <span class="n">all_tfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">tfile_all_glob_str</span><span class="p">)</span>
        <span class="n">numbered_tfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">tfile_num_glob_str</span><span class="p">)</span>
        <span class="n">tfile_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">tfile</span> <span class="k">for</span> <span class="n">tfile</span> <span class="ow">in</span> <span class="n">all_tfiles</span> <span class="k">if</span> <span class="n">tfile</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">numbered_tfiles</span><span class="p">]</span>
        <span class="n">afile_name</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;[!</span><span class="si">{}</span><span class="s1">]*[!0-9][!</span><span class="si">{}</span><span class="s1">]</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_tfile_prefix</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_dump_suffix</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_file_suffix</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">tfile_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">afile_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1">#            Trimming            #</span>
<span class="c1">##################################</span>
    <span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trim_beg</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">trim_end</span><span class="o">=</span><span class="mf">0.35</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iv_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span><span class="p">:</span>
            <span class="n">iv_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.iv_data not set, running homogenise now...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">make_denormaliser</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">iv_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span>

        <span class="c1"># Cut off the noise in the electron saturation region</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Splopter</span><span class="o">.</span><span class="n">trim_generic</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">TIME</span><span class="p">],</span> <span class="n">trim_beg</span><span class="o">=</span><span class="n">trim_beg</span><span class="p">,</span> <span class="n">trim_end</span><span class="o">=</span><span class="n">trim_end</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">Splopter</span><span class="o">.</span><span class="n">trim_generic</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">],</span> <span class="n">trim_beg</span><span class="o">=</span><span class="n">trim_beg</span><span class="p">,</span> <span class="n">trim_end</span><span class="o">=</span><span class="n">trim_end</span><span class="p">)</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">Splopter</span><span class="o">.</span><span class="n">trim_generic</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">CURRENT</span><span class="p">],</span> <span class="n">trim_beg</span><span class="o">=</span><span class="n">trim_beg</span><span class="p">,</span> <span class="n">trim_end</span><span class="o">=</span><span class="n">trim_end</span><span class="p">)</span>
        <span class="n">I_e</span> <span class="o">=</span> <span class="n">Splopter</span><span class="o">.</span><span class="n">trim_generic</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">ELEC_CURRENT</span><span class="p">],</span> <span class="n">trim_beg</span><span class="o">=</span><span class="n">trim_beg</span><span class="p">,</span> <span class="n">trim_end</span><span class="o">=</span><span class="n">trim_end</span><span class="p">)</span>
        <span class="n">I_i</span> <span class="o">=</span> <span class="n">Splopter</span><span class="o">.</span><span class="n">trim_generic</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">ION_CURRENT</span><span class="p">],</span> <span class="n">trim_beg</span><span class="o">=</span><span class="n">trim_beg</span><span class="p">,</span> <span class="n">trim_end</span><span class="o">=</span><span class="n">trim_end</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">IVData</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">i_current</span><span class="o">=</span><span class="n">I_i</span><span class="p">,</span> <span class="n">e_current</span><span class="o">=</span><span class="n">I_e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">denormalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">denormalise_t_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">denormalise_t_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">denormalise_t_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">denormalise_t_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">denormalise</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1">#             Fitting            #</span>
<span class="c1">##################################</span>
    <span class="k">def</span> <span class="nf">get_vf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iv_data</span><span class="p">:</span>
            <span class="n">iv_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span>

        <span class="n">iv_interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">CURRENT</span><span class="p">],</span> <span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">])</span>
        <span class="n">v_float</span> <span class="o">=</span> <span class="n">iv_interp</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">v_float</span>

    <span class="k">def</span> <span class="nf">get_plasma_potential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iv_data</span><span class="p">:</span>
            <span class="n">iv_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span>

        <span class="n">vf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vf</span><span class="p">(</span><span class="n">iv_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">vf</span><span class="p">)</span>

        <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="o">-</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">CURRENT</span><span class="p">])</span>
        <span class="n">gradient2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">argrelmax</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>

        <span class="n">smoothed_gradient</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">smoothed_peaks</span> <span class="o">=</span> <span class="n">argrelmax</span><span class="p">(</span><span class="n">smoothed_gradient</span><span class="p">)</span>

        <span class="c1"># print(gradient)</span>
        <span class="c1"># print(peaks)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gradient</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="c1"># plt.plot(iv_data[POTENTIAL], iv_data[CURRENT])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">],</span> <span class="n">gradient</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">],</span> <span class="n">smoothed_gradient</span><span class="p">)</span>
        <span class="c1"># plt.plot(iv_data[POTENTIAL], gradient2)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">][[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">smoothed_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">][</span><span class="n">p</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vf</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># for p in [p for p in smoothed_peaks[0] if iv_data[POTENTIAL][p] &gt; vf]:</span>
        <span class="c1">#     plt.axvline(iv_data[POTENTIAL][p], linewidth=1, color=&#39;r&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">phi</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">print_fl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initial_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Reimplement the finding of floating potential</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iv_data</span><span class="p">:</span>
            <span class="n">iv_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span>

        <span class="n">v_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vf</span><span class="p">(</span><span class="n">iv_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">v_f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fitter</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fitter</span><span class="p">,</span> <span class="n">IVFitter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fitter</span> <span class="o">=</span> <span class="n">FullIVFitter</span><span class="p">()</span>

        <span class="n">fit_data</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fit_iv_data</span><span class="p">(</span><span class="n">iv_data</span><span class="p">,</span> <span class="n">initial_vals</span><span class="o">=</span><span class="n">initial_vals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_fl</span><span class="p">:</span>
            <span class="n">fit_data</span><span class="o">.</span><span class="n">print_fit_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fit_data</span>

    <span class="k">def</span> <span class="nf">temperature_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">vf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vf</span><span class="p">(</span><span class="n">iv_data</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plasma_potential</span><span class="p">(</span><span class="n">iv_data</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span><span class="o">.</span><span class="n">get_mu</span><span class="p">()))</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">vf</span><span class="p">)</span> <span class="o">/</span> <span class="n">const</span>
        <span class="k">return</span> <span class="n">temperature</span>

    <span class="c1"># Guess parameters from previous fitting routines</span>
        <span class="c1"># These are taken from Sam&#39;s paper</span>
        <span class="c1"># v_float = self.get_vf()</span>
        <span class="c1"># e_temp = 1  # eV</span>
        <span class="c1"># I_0_sam = 32.774</span>
        <span class="c1"># a_sam = 0.0204</span>

    <span class="c1"># Parameters for the full fitting function [I_0, a, v_float, electron_temperature]</span>
        <span class="c1"># params = [I_0_sam, a_sam, v_float, e_temp]</span>
        <span class="c1"># bounds = ([-np.inf, 0, v_float - 0.01, -np.inf],</span>
        <span class="c1">#           [np.inf, np.inf, v_float, np.inf])</span>

    <span class="c1"># Parameters for the simple fitting function (no sheath expansion)</span>
        <span class="c1"># params_simple = [I_0_sam, v_float, e_temp]</span>
        <span class="c1"># bounds_simple = ([-np.inf, v_float - 0.01, -np.inf],</span>
        <span class="c1">#                 [np.inf, v_float, np.inf])</span>

    <span class="c1"># Parameters for the straight line fitting function</span>
        <span class="c1"># sl_V = np.power(np.abs(V), 0.75)</span>
        <span class="c1"># sl_params = [I_0_sam, a_sam]</span>
        <span class="c1"># sl_bounds = ([-np.inf, 0],</span>
        <span class="c1">#              [np.inf, np.inf])</span>

<span class="c1">###########################################</span>
<span class="c1">#              DF Extraction              #</span>
<span class="c1">###########################################</span>

    <span class="k">def</span> <span class="nf">find_se_temp_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v_scale</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">plot_fl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: (14/01/19) Make function to find regions from simulation object geometry first, then tries to interpret</span>
        <span class="c1"># TODO: from the input file.</span>
        <span class="c1"># If no regions specified, find them from diagnostic regions in input file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regions</span><span class="p">:</span>
            <span class="n">regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_hist_diag_regions</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>

        <span class="c1"># If still not regions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: No viable sheath edge comparison regions provided or found, using defaults.&#39;</span><span class="p">)</span>
            <span class="n">regions</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Sheath Edge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">74</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>       <span class="c1"># Sheath edge</span>
                <span class="s1">&#39;Injection&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">354</span><span class="p">,</span> <span class="mi">370</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>        <span class="c1"># Injection area</span>
            <span class="p">}</span>

        <span class="n">hists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_histograms</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">regions</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">denormalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">v_scale</span><span class="o">=</span><span class="n">v_scale</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_commented_params</span><span class="p">()[</span><span class="n">c</span><span class="o">.</span><span class="n">ELEC_TEMP</span><span class="p">]</span>

        <span class="n">fitdatas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fitter</span> <span class="o">=</span> <span class="n">GaussianFitter</span><span class="p">(</span><span class="n">si_units</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">v_scale</span><span class="o">=</span><span class="n">v_scale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hist_data</span> <span class="ow">in</span> <span class="n">hists</span><span class="p">:</span>
            <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">hist_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hist_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">temp</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
            <span class="n">fitdatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_fl</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hists</span><span class="p">)):</span>
                <span class="n">fitdatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">print_fit_params</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">hists</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Hist - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">regions</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">fitdatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_fit_plottables</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="n">fitdatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">fitdatas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sheath edge temperature ratio is: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ratio</span>

    <span class="k">def</span> <span class="nf">extract_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">denormalise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">v_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">deallocate_fl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">denormalise</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">homogenise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">homogenise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_denormaliser</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">nproc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">nproc</span><span class="p">))</span>
        <span class="n">region_vels</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
        <span class="n">ralpha</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">alphayz</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">3.141591</span>
        <span class="n">rbeta</span> <span class="o">=</span> <span class="p">((</span><span class="mf">90.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">alphaxz</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="mf">3.141591</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nproc</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfile_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.mat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
            <span class="n">p_file</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
                <span class="n">z_low</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">z_high</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">y_low</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">y_high</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">p_file</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">z_low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_file</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z_high</span><span class="p">)</span>
                                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_file</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y_low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_file</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_high</span><span class="p">)</span>
                                   <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_file</span><span class="p">[</span><span class="s1">&#39;stype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">species</span><span class="p">))</span>
                <span class="n">region_vels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_vels</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">p_file</span><span class="p">[</span><span class="s1">&#39;uy&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ralpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rbeta</span><span class="p">))</span>
                                           <span class="o">-</span> <span class="p">(</span><span class="n">p_file</span><span class="p">[</span><span class="s1">&#39;uz&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ralpha</span><span class="p">)))</span>

        <span class="n">hists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">region_vels</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">denormalise</span><span class="p">:</span>
                <span class="n">region_vels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormaliser</span><span class="p">(</span><span class="n">region_vels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">CONV_VELOCITY</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v_scale</span><span class="p">:</span>
                <span class="n">region_vels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_vels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">v_scale</span>

            <span class="n">hist</span><span class="p">,</span> <span class="n">gaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="o">-</span><span class="n">region_vels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaps</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">gaps</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">hists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">bins</span><span class="p">,</span> <span class="n">hist</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">deallocate_fl</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">gc</span>
            <span class="k">del</span> <span class="n">region_vels</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">hists</span>

<span class="c1">##################################</span>
<span class="c1">#              Plot              #</span>
<span class="c1">##################################</span>
    <span class="n">AX_LABEL_IV</span> <span class="o">=</span> <span class="s1">&#39;IV&#39;</span>
    <span class="n">AX_LABEL_ION_FIT</span> <span class="o">=</span> <span class="s1">&#39;Ion Current&#39;</span>
    <span class="n">_AXES_LABELS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">AX_LABEL_IV</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{V}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{I}</span><span class="s1">$&#39;</span><span class="p">],</span>
        <span class="n">AX_LABEL_ION_FIT</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$|\hat</span><span class="si">{V}</span><span class="s1">|^{3/4}$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{I}</span><span class="s1">_i$&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">plot_iv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iv_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_vf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_tot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_i</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_e</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="n">show_fl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fig</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">iv_data</span><span class="p">:</span>
            <span class="n">iv_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span>

        <span class="k">if</span> <span class="n">plot_tot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">CURRENT</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_e</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">ELEC_CURRENT</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Electron&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_i</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">ION_CURRENT</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ion&#39;</span><span class="p">)</span>

        <span class="c1"># plt.plot(V, I_i, label=&#39;Ion&#39;)</span>
        <span class="c1"># plt.plot(V, I_e, label=&#39;Electron&#39;)</span>
        <span class="c1"># plt.plot(V, I_i, label=&#39;Fitted section&#39;)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_vf</span><span class="p">:</span>
            <span class="n">v_float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">v_float</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;V$_</span><span class="si">{float}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">v_float</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

        <span class="c1"># plt.plot(V_full, I_fitted, label=&#39;Fit&#39;)</span>
        <span class="c1"># plt.plot(V, I_fitted_simple, label=&#39;Simple&#39;)</span>
        <span class="c1"># plt.plot(V, I_sam, label=&#39;Sam\&#39;s Params&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{V}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{I}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">show_fl</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_f_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv_fit_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_vf</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fig</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">plot_raw</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">iv_fit_data</span><span class="o">.</span><span class="n">get_raw_plottables</span><span class="p">(),</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">iv_fit_data</span><span class="o">.</span><span class="n">get_fit_plottables</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_vf</span><span class="p">:</span>
            <span class="n">v_float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">v_float</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;V$_</span><span class="si">{float}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">v_float</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_AXES_LABELS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AX_LABEL_IV</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_AXES_LABELS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AX_LABEL_IV</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_i_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv_fit_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fig</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">iv_fit_data</span><span class="o">.</span><span class="n">get_raw_plottables</span><span class="p">(),</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">iv_fit_data</span><span class="o">.</span><span class="n">get_fit_plottables</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$|V|^{3/4}$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$I_i$&#39;</span><span class="p">)</span>
        <span class="c1"># plt.legend()</span>

<span class="c1">######################</span>
<span class="c1">#    Raw Data Plot   #</span>
<span class="c1">######################</span>
    <span class="k">def</span> <span class="nf">plot_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_list</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;I_e&#39;</span><span class="p">,</span> <span class="s1">&#39;I_i&#39;</span><span class="p">),</span> <span class="n">show_fl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fig</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="n">_PLOTTABLE</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">c</span><span class="o">.</span><span class="n">POTENTIAL</span><span class="p">:</span> <span class="s1">&#39;Raw Voltage&#39;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">.</span><span class="n">CURRENT</span><span class="p">:</span> <span class="s1">&#39;Raw Current&#39;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">.</span><span class="n">ELEC_CURRENT</span><span class="p">:</span> <span class="s1">&#39;Raw Electron Current&#39;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">.</span><span class="n">ION_CURRENT</span><span class="p">:</span> <span class="s1">&#39;Raw Ion Current&#39;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not plot raw, no variables given in plot_list&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">plot_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">_PLOTTABLE</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iv_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">TIME</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">var</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">_PLOTTABLE</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">show_fl</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_1d_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable_label</span><span class="o">=</span><span class="n">sd</span><span class="o">.</span><span class="n">OBJECTSCURRENTE</span><span class="p">,</span> <span class="n">time_dep_fl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">diagnostic_fl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">show_fl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">diagnostic_fl</span><span class="p">:</span>
            <span class="n">y_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">t_dict</span><span class="p">[</span><span class="n">variable_label</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">[</span><span class="n">variable_label</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">time_dep_fl</span><span class="p">:</span>
            <span class="n">x_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_var</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fig</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_var</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_var</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_var</span><span class="p">,</span> <span class="n">y_var</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_var</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_fl</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_2d_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_dict_label</span><span class="o">=</span><span class="n">sd</span><span class="o">.</span><span class="n">POT</span><span class="p">,</span> <span class="n">plot_obj_fl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_fl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">plasma_parameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">t_dict</span><span class="p">[</span><span class="n">t_dict_label</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">objects_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">objectsenum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">probe_obj_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_probe_obj_indices</span><span class="p">()</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">plasma_parameter</span><span class="p">))</span>

        <span class="n">wall_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">plasma_parameter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">probe_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">objects_raw</span> <span class="o">==</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">probe_obj_indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">plot_obj_fl</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">objects_raw</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

        <span class="n">plasma_parameter</span><span class="p">[</span><span class="n">wall_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="k">for</span> <span class="n">probe_obj</span> <span class="ow">in</span> <span class="n">probe_objs</span><span class="p">:</span>
            <span class="n">plasma_parameter</span><span class="p">[</span><span class="n">probe_obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">objects</span><span class="p">[</span><span class="n">wall_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="k">for</span> <span class="n">probe_obj</span> <span class="ow">in</span> <span class="n">probe_objs</span><span class="p">:</span>
            <span class="n">objects</span><span class="p">[</span><span class="n">probe_obj</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plasma_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plasma_parameter</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">plasma_parameter</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plasma_parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plasma_parameter</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                       <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;y / $\lambda_D$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;z / $\lambda_D$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="c1"># plt.title(&#39;Electrostatic potential for a flush mounted probe&#39;, fontsize=20)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">([</span><span class="mi">200</span><span class="p">],</span> <span class="p">[</span><span class="mi">200</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">by</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdata</span><span class="o">.</span><span class="n">bz</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.035</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_fl</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">analyse_iv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_fl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">iv_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">trim_end</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">fit_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">iv_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_raw</span><span class="p">(</span><span class="n">plot_list</span><span class="o">=</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">CURRENT</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">ION_CURRENT</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">ELEC_CURRENT</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_iv</span><span class="p">(</span><span class="n">plot_vf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_tot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_fl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_fl</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jack Leland

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>